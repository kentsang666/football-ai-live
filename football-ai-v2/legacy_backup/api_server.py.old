from flask import Flask, jsonify, request, render_template
from flask_cors import CORS
from sqlalchemy.orm import Session
from database_models import SessionLocal, Match
import datetime
import logging
import os

# Configure logging
log_dir = "logs"
if not os.path.exists(log_dir):
    os.makedirs(log_dir)
logging.basicConfig(filename=os.path.join(log_dir, 'api.log'), level=logging.ERROR, 
                    format='%(asctime)s %(levelname)s: %(message)s')

app = Flask(__name__)
# å¯ç”¨ CORSï¼Œå…è®¸å‰ç«¯(å¦‚ Vue/React/HTML)è·¨åŸŸè®¿é—®
CORS(app) 

# ===========================
# é¡µé¢è·¯ç”±
# ===========================
@app.route('/')
def home():
    return render_template('index.html')

# ===========================
# æ•°æ®åº“è¾…åŠ©å‡½æ•°
# ===========================
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# ===========================
# æ¥å£ 1: è·å–æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„æ¯”èµ› (æ»šçƒåˆ—è¡¨)
# ===========================
@app.route('/api/live', methods=['GET'])
def get_live_matches_compat():
    """å…¼å®¹æ—§ç‰ˆå‰ç«¯è¯·æ±‚ /api/live"""
    return get_live_matches()

@app.route('/api/live-matches', methods=['GET'])
def get_live_matches():
    session = SessionLocal()
    try:
        # æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€ä¸º 'LIVE' æˆ–ç›¸å…³çŠ¶æ€çš„æ¯”èµ›
        live_statuses = ['LIVE', '1H', '2H', 'HT', 'ET', 'BT', 'P', 'INT']
        live_matches = session.query(Match).filter(Match.status.in_(live_statuses)).order_by(Match.league_id).all()
        
        results = []
        for match in live_matches:
            # 1. AI é¢„æµ‹æ–‡æ¡ˆ (å¢åŠ  None å€¼ä¿æŠ¤)
            h_prob = match.live_home_win_prob or 0
            a_prob = match.live_away_win_prob or 0
            d_prob = match.live_draw_prob or 0
            
            prediction_text = "BALANCED"
            if h_prob > 60: prediction_text = "HOME STRONG"
            elif a_prob > 60: prediction_text = "AWAY STRONG"
            # æ³¨æ„: å¦‚æœèƒœ+å¹³æ¦‚ç‡å¾ˆé«˜ï¼Œå¯èƒ½æ˜¯ä¸»ä¸è´¥
            elif h_prob + d_prob > 80: prediction_text = "HOME 1X"
            
            # 2. æ„é€ å‰ç«¯éœ€è¦çš„ odds_ou (å¤§å°çƒ)
            # å¢åŠ  None å€¼ä¿æŠ¤
            over_prob = match.live_over_25_prob or 0
            under_prob = match.live_under_25_prob or 0
            
            ou_line = "2.5" 
            over_val = f"{over_prob}%"
            under_val = f"{under_prob}%"
            
            # 3. æ„é€ å‰ç«¯ç»“æ„
            results.append({
                "id": match.id,
                "league": match.league_name,
                "display_time": str(match.current_minute) + "'",
                "home_team": match.home_team,
                "away_team": match.away_team,
                "home_score": match.home_score,
                "away_score": match.away_score,
                "home_red_cards": match.red_cards_home,
                "away_red_cards": match.red_cards_away,
                
                "ai_analysis": {
                    "home_prob": int(h_prob),
                    "draw_prob": int(d_prob),
                    "away_prob": int(a_prob),
                    "ai_prediction": prediction_text
                },
                
                "odds_ou": {
                    "line": ou_line,
                    "o": over_val,
                    "u": under_val
                },
                
                # æš‚æ—¶ Mock äºšç›˜æ•°æ®ï¼Œé˜²æ­¢å‰ç«¯æŠ¥é”™
                "odds_ah": {
                    "val": "0.0",
                    "h": "-",
                    "a": "-"
                },
                
                # æš‚æ—¶ Mock è¿›é˜¶æ•°æ®
                "advanced_analytics": {
                    "momentum": { "home": 50, "away": 50 },
                    "signal": None
                }
            })
            
        return jsonify({
            "count": len(results),
            "matches": results,
            "timestamp": datetime.datetime.now().isoformat()
        })
        
    except Exception as e:
        print(f"API Error: {e}")
        logging.error(f"API Error in /api/live-matches: {e}", exc_info=True)
        return jsonify({"error": str(e)}), 500
    finally:
        session.close()

# ===========================
# æ¥å£ 2: è·å–ä»Šæ—¥æ‰€æœ‰æ¯”èµ› (åŒ…æ‹¬æœªå¼€å§‹çš„)
# ===========================
@app.route('/api/today-matches', methods=['GET'])
def get_today_matches():
    session = SessionLocal()
    try:
        # è·å–æ‰€æœ‰éå®Œåœºçš„æ¯”èµ›
        matches = session.query(Match).filter(Match.status != 'FT').all()
        
        results = []
        for match in matches:
            results.append({
                "id": match.id,
                "teams": f"{match.home_team} vs {match.away_team}",
                "status": match.status,
                "start_time": match.start_time.strftime('%H:%M') if match.start_time else "TBD",
                "pre_win_prob": match.pre_home_win_prob # èµ›å‰èƒœç‡
            })
            
        return jsonify({"matches": results})
    finally:
        session.close()


# ===========================
# æ¥å£ 3: è·å–ç³»ç»Ÿæ—¥å¿—
# ===========================
@app.route('/api/logs', methods=['GET'])
def get_logs():
    log_file = 'logs/main.log'
    logs = []
    try:
        # å°è¯•è¯»å–æ—¥å¿—æ–‡ä»¶çš„æœ€å 20 è¡Œ
        import os
        if os.path.exists(log_file):
            with open(log_file, 'r', encoding='utf-8') as f:
                # ç®€å•è¯»å–æ‰€æœ‰è¡Œç„¶ååˆ‡ç‰‡ (ç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨åˆ«çš„åº“ seek)
                lines = f.readlines()
                logs = [l.strip() for l in lines[-20:]]
    except Exception as e:
        logs = [f"Error reading logs: {str(e)}"]
        
    return jsonify({"logs": logs})

# ===========================
# å¯åŠ¨æœåŠ¡å™¨
# ===========================
if __name__ == '__main__':
    print("ğŸš€ API æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:5000")
    # debug=True æ–¹ä¾¿è°ƒè¯•ï¼ŒæŠ¥é”™ä¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    # host='0.0.0.0' å…è®¸å±€åŸŸç½‘å†…å…¶ä»–ç”µè„‘/æ‰‹æœºè®¿é—®
    app.run(debug=True, host='0.0.0.0', port=5000)
