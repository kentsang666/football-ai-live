import subprocess
import time
import sys
import os
import signal

def main():
    print("ğŸš€ æ­£åœ¨å¯åŠ¨ NeuroBall AI å…¨å¥—æœåŠ¡...")
    
    processes = []
    
    try:
        # 1. å¯åŠ¨è°ƒåº¦å™¨ (è´Ÿè´£åˆå§‹åŒ– DB å’Œå®šæ—¶æŠ“å–èµ›å‰æ•°æ®)
        print(" -> [1/3] å¯åŠ¨æ—¥å¸¸è°ƒåº¦å™¨ (daily_scheduler.py)...")
        p_scheduler = subprocess.Popen(
            [sys.executable, "daily_scheduler.py"],
            cwd=os.getcwd(),
            shell=False 
        )
        processes.append(p_scheduler)
        time.sleep(3) # ç­‰å¾…3ç§’ï¼Œç¡®ä¿æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
        
        # 2. å¯åŠ¨å®æ—¶ç›‘æ§ (è´Ÿè´£æŠ“å–å®æ—¶æ¯”åˆ†å’Œè®¡ç®—æ»šçƒèƒœç‡)
        print(" -> [2/3] å¯åŠ¨å®æ—¶ç›‘æ§å™¨ (live_monitor.py)...")
        p_monitor = subprocess.Popen(
            [sys.executable, "live_monitor.py"],
            cwd=os.getcwd(),
            shell=False
        )
        processes.append(p_monitor)
        time.sleep(2)
        
        # 3. å¯åŠ¨ Web æœåŠ¡ (API Server)
        print(" -> [3/3] å¯åŠ¨ API æœåŠ¡å™¨ (api_server.py)...")
        p_main = subprocess.Popen(
            [sys.executable, "api_server.py"],
            cwd=os.getcwd(),
            shell=False
        )
        processes.append(p_main)
        
        print("\nâœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ï¼")
        print("ğŸ“ æ—¥å¿—å°†æ··åˆè¾“å‡ºåˆ°æœ¬ç»ˆç«¯ã€‚")
        print("ğŸŒ è®¿é—® API: http://localhost:5000/api/live-matches")
        print("âŒ æŒ‰ Ctrl+C å¯ä»¥ä¸€é”®åœæ­¢æ‰€æœ‰æœåŠ¡ã€‚")
        
        # ä¿æŒä¸»è¿›ç¨‹è¿è¡Œï¼Œå¹¶ç›‘å¬å­è¿›ç¨‹çŠ¶æ€
        while True:
            time.sleep(1)
            # æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹æ„å¤–é€€å‡º
            if p_scheduler.poll() is not None:
                print("âš ï¸ è­¦å‘Š: è°ƒåº¦å™¨å·²é€€å‡º")
            if p_monitor.poll() is not None:
                print("âš ï¸ è­¦å‘Š: ç›‘æ§å™¨å·²é€€å‡º")
            if p_main.poll() is not None:
                print("âš ï¸ è­¦å‘Š: API æœåŠ¡å™¨å·²é€€å‡º")
                break # ä¸»æœåŠ¡æŒ‚äº†å°±é€€å‡º
                
    except KeyboardInterrupt:
        print("\nğŸ›‘ æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡...")
    finally:
        for p in processes:
            if p.poll() is None: # è¿˜åœ¨è¿è¡Œ
                p.terminate()
                try:
                    p.wait(timeout=2)
                except subprocess.TimeoutExpired:
                    p.kill()
        print("ğŸ‘‹ æœåŠ¡å·²å…¨éƒ¨å…³é—­ã€‚")

if __name__ == "__main__":
    main()
