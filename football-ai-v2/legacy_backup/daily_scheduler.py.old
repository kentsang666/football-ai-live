import schedule
import time
import datetime
import requests
from sqlalchemy.orm import Session
from prediction_engine import FootballPredictionSystem
from database_models import SessionLocal, Match, init_db
from model_utils import get_team_rating

# API Config
API_KEY = "8b86ae86981996818bbdcafafa10717f"
API_URL = "https://v3.football.api-sports.io/fixtures"

# --- æ•°æ®åº“æ“ä½œå‡½æ•° ---
def save_daily_matches_to_db(fixtures):
    """
    å°†è®¡ç®—å¥½çš„èµ›å‰æ•°æ®å­˜å…¥æ•°æ®åº“ã€‚
    å¦‚æœæ¯”èµ›å·²å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ (Upserté€»è¾‘)ã€‚
    """
    session = SessionLocal()
    try:
        print(f"ğŸ’¾ æ­£åœ¨ä¿å­˜ {len(fixtures)} åœºæ¯”èµ›æ•°æ®åˆ°æ•°æ®åº“...")
        
        for match_data in fixtures:
            # 1. å°è¯•åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾è¿™åœºæ¯”èµ›
            existing_match = session.query(Match).filter(Match.id == match_data['id']).first()
            
            if existing_match:
                # æ›´æ–°ï¼šå¦‚æœæ¯”èµ›å·²å­˜åœ¨ï¼Œæ›´æ–°èµ›å‰æ•°æ®
                existing_match.pre_match_home_lambda = match_data['pre_match_home_lambda']
                existing_match.pre_match_away_lambda = match_data['pre_match_away_lambda']
                existing_match.pre_home_win_prob = match_data['pre_home_win_prob']
                existing_match.pre_draw_prob = match_data['pre_draw_prob']
                existing_match.pre_away_win_prob = match_data['pre_away_win_prob']
                existing_match.status = match_data['status']
                
                # åªæœ‰å½“è¿™äº›å­—æ®µå­˜åœ¨æ—¶æ‰æ›´æ–°ï¼ˆé˜²æ­¢è¦†ç›–ä¸ºç©ºï¼‰
                if match_data.get('league_id'): existing_match.league_id = match_data['league_id']
                if match_data.get('league_name'): existing_match.league_name = match_data['league_name']
                if match_data.get('start_time'): existing_match.start_time = match_data['start_time']
                
                print(f"  Start update match: {match_data['id']}")
            else:
                # æ’å…¥ï¼šå¦‚æœæ¯”èµ›ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•
                new_match = Match(
                    id=match_data['id'],
                    league_id=match_data.get('league_id'),
                    league_name=match_data.get('league_name'),
                    home_team=match_data['home_team'],
                    away_team=match_data['away_team'],
                    start_time=match_data.get('start_time'),
                    status=match_data['status'],
                    
                    # æ ¸å¿ƒèµ›å‰æ•°æ®
                    pre_match_home_lambda=match_data['pre_match_home_lambda'],
                    pre_match_away_lambda=match_data['pre_match_away_lambda'],
                    pre_home_win_prob=match_data['pre_home_win_prob'],
                    pre_draw_prob=match_data['pre_draw_prob'],
                    pre_away_win_prob=match_data['pre_away_win_prob']
                )
                session.add(new_match)
                print(f"  New match added: {match_data['id']}")
        
        session.commit()
        print("âœ… æ‰€æœ‰èµ›å‰æ•°æ®å…¥åº“æˆåŠŸï¼")
        
    except Exception as e:
        session.rollback()
        print(f"âŒ æ•°æ®åº“å†™å…¥é”™è¯¯: {e}")
    finally:
        session.close()

# --- çœŸå® API è·å–å‡½æ•° ---
def get_todays_fixtures():
    print("ğŸ“¡ æ­£åœ¨è¿æ¥ API è·å–ä»Šæ—¥æ¯”èµ›åˆ—è¡¨...")
    
    headers = {
        'x-apisports-key': API_KEY,
        'x-rapidapi-host': "v3.football.api-sports.io"
    }
    
    # è·å–ä»Šæ—¥æ—¥æœŸ YYYY-MM-DD
    today = datetime.datetime.now().strftime("%Y-%m-%d")
    
    try:
        response = requests.get(f"{API_URL}?date={today}", headers=headers, timeout=10)
        
        if response.status_code != 200:
            print(f"âŒ API è¯·æ±‚å¤±è´¥: {response.status_code}")
            return []
            
        data = response.json()
        raw_fixtures = data.get('response', [])
        
        parsed_fixtures = []
        for item in raw_fixtures:
            fixture_id = item['fixture']['id']
            # è·å–ç”¨æˆ·è¦æ±‚çš„é¢å¤–å­—æ®µ
            league_id = item['league']['id']
            league_name = item['league']['name']
            
            # API è¿”å›çš„æ—¶é—´æ˜¯ ISO8601 (2025-05-20T14:30:00+00:00)
            start_time_str = item['fixture']['date']
            try:
                # å°è¯•è§£æ ISO æ ¼å¼
                start_time = datetime.datetime.fromisoformat(start_time_str.replace('Z', '+00:00'))
                # è½¬ä¸º naive datetime (å»æ‰æ—¶åŒºä¿¡æ¯ï¼Œä¸æ•°æ®åº“ä¿æŒä¸€è‡´)
                start_time = start_time.replace(tzinfo=None)
            except:
                start_time = datetime.datetime.now()

            status = item['fixture']['status']['short']
            
            # --- Status Normalization Fix ---
            # If the API says it's in play, normalize to 'LIVE' to match live_monitor and api_server expectations
            if status in ['1H', '2H', 'HT', 'ET', 'BT', 'P', 'INT']:
                status = 'LIVE'
            # --------------------------------

            home_team_name = item['teams']['home']['name']
            away_team_name = item['teams']['away']['name']
            
            # ä½¿ç”¨ model_utils è·å–ï¼ˆæˆ–ä¼°ç®—ï¼‰èƒ½åŠ›å€¼
            home_stats = get_team_rating(home_team_name)
            away_stats = get_team_rating(away_team_name)
            
            parsed_fixtures.append({
                'id': fixture_id,
                'league_id': league_id,
                'league_name': league_name,
                'start_time': start_time,
                'status': status,
                'home_team': home_team_name,
                'away_team': away_team_name,
                'home_stats': home_stats,
                'away_stats': away_stats
            })
            
        print(f"ğŸ“¥ è·å–åˆ° {len(parsed_fixtures)} åœºä»Šæ—¥æ¯”èµ›")
        return parsed_fixtures
        
    except Exception as e:
        print(f"âŒ API è¯·æ±‚å¼‚å¸¸: {e}")
        return []

# --- ä¸»é€»è¾‘ï¼šè·å– -> è®¡ç®— -> å­˜åº“ ---
def fetch_and_calculate_today():
    print(f"\nâ° ä»»åŠ¡è§¦å‘: {datetime.datetime.now()}")
    
    # 1. åˆå§‹åŒ–é¢„æµ‹å¼•æ“
    predictor = FootballPredictionSystem()
    
    # 2. è°ƒç”¨çœŸå®çš„ API è·å–æ•°æ®
    fixtures_list = get_todays_fixtures()
    
    processed_data = []
    
    # 3. è®¡ç®—æ¯åœºæ¯”èµ›çš„ Lambda å€¼
    for match in fixtures_list:
        h_exp, a_exp = predictor.calculate_prematch_lambda(match['home_stats'], match['away_stats'])
        probs = predictor.get_match_probabilities(h_exp, a_exp)
        
        # æ•´ç†è¦å­˜å…¥æ•°æ®åº“çš„å­—å…¸
        match_record = {
            'id': match['id'],
            'league_id': match['league_id'],
            'league_name': match['league_name'],
            'home_team': match['home_team'],
            'away_team': match['away_team'],
            'start_time': match['start_time'],
            'status': match['status'],
            
            # è®¡ç®—ç»“æœ
            'pre_match_home_lambda': h_exp,
            'pre_match_away_lambda': a_exp,
            'pre_home_win_prob': probs[0] * 100,
            'pre_draw_prob': probs[1] * 100,
            'pre_away_win_prob': probs[2] * 100
        }
        processed_data.append(match_record)
    
    # 4. å­˜å…¥æ•°æ®åº“
    if processed_data:
        save_daily_matches_to_db(processed_data)
    else:
        print("âš ï¸ ä»Šæ—¥æ²¡æœ‰è·å–åˆ°æ¯”èµ›æ•°æ®")

# --- è°ƒåº¦å™¨è®¾ç½® ---
def run_scheduler():
    # ç¡®ä¿æ•°æ®åº“è¡¨å·²å­˜åœ¨
    init_db()
    
    # è®¾å®šæ¯å¤© 12:00 è¿è¡Œ
    schedule.every().day.at("12:00").do(fetch_and_calculate_today)
    
    # ä¸ºäº†æµ‹è¯•ï¼Œè¿™é‡Œè®¾ç½®ä¸ºæ¯ 10 ç§’è¿è¡Œä¸€æ¬¡
    # å¦‚æœæ‚¨æƒ³æ¢å¤æˆæ¯å¤©è¿è¡Œï¼Œè¯·æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œ
    schedule.every(10).seconds.do(fetch_and_calculate_today)
    
    print("ğŸš€ èµ›å‰æ•°æ®è°ƒåº¦å™¨å·²å¯åŠ¨ (æµ‹è¯•æ¨¡å¼: æ¯10ç§’è¿è¡Œ)...")
    
    # æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡ä»¥ä¾¿ç«‹å³æŸ¥çœ‹æ•ˆæœ
    fetch_and_calculate_today()
    
    while True:
        schedule.run_pending()
        time.sleep(1)

if __name__ == "__main__":
    run_scheduler()
